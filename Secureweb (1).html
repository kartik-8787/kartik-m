<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Secure Messaging Web App</title>
<style>
  body {
      font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
          margin: 20px;
              background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
                  color: #333;
                    }

                      h1 {
                          text-align: center;
                              color: #222;
                                  margin-bottom: 10px;
                                      font-size: 2em;
                                        }

                                          /* Responsive font size for headings */
                                            @media(max-width: 600px) {
                                                h1 { font-size: 1.5em; }
                                                  }

                                                    /* Colors and styles for buttons */
                                                      button {
                                                          background: linear-gradient(135deg, #ff7e5f, #feb47b);
                                                              border: none;
                                                                  padding: 12px 24px;
                                                                      margin: 8px 0;
                                                                          font-size: 16px;
                                                                              color: #fff;
                                                                                  border-radius: 12px;
                                                                                      cursor: pointer;
                                                                                          box-shadow: 0 8px 20px rgba(0,0,0,0.15);
                                                                                              transition: all 0.3s ease;
                                                                                                  width: 100%;
                                                                                                      max-width: 300px;
                                                                                                        }
                                                                                                          button:hover {
                                                                                                              background: linear-gradient(135deg, #feb47b, #ff7e5f);
                                                                                                                  transform: translateY(-2px);
                                                                                                                    }

                                                                                                                      /* Inputs and textareas with flexible width and spacing */
                                                                                                                        input, textarea {
                                                                                                                            width: 100%;
                                                                                                                                max-width: 700px;
                                                                                                                                    padding: 12px;
                                                                                                                                        margin: 8px 0;
                                                                                                                                            border-radius: 10px;
                                                                                                                                                border: 1px solid #ccc;
                                                                                                                                                    font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
                                                                                                                                                        font-size: 14px;
                                                                                                                                                            box-sizing: border-box;
                                                                                                                                                              }

                                                                                                                                                                /* Container styles for sections with responsive layout */
                                                                                                                                                                section {
                                                                                                                                                                  background: rgba(255, 255, 255, 0.8);
                                                                                                                                                                    padding: 20px;
                                                                                                                                                                      margin-top: 30px;
                                                                                                                                                                        border-radius: 15px;
                                                                                                                                                                          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                                                                                                                                                            width: 100%;
                                                                                                                                                                              box-sizing: border-box;
                                                                                                                                                                              }

                                                                                                                                                                              /* Main app hidden initially, login visible */
                                                                                                                                                                              #appSection {
                                                                                                                                                                                display: none; /* shown after login */
                                                                                                                                                                                }

                                                                                                                                                                                #loginSection {
                                                                                                                                                                                  max-width: 400px;
                                                                                                                                                                                    margin: 0 auto 30px auto;
                                                                                                                                                                                      padding: 20px;
                                                                                                                                                                                        background: #fff;
                                                                                                                                                                                          border-radius: 15px;
                                                                                                                                                                                            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                                                                                                                                                                              width: 90%;
                                                                                                                                                                                                box-sizing: border-box;
                                                                                                                                                                                                }

                                                                                                                                                                                                /* Responsive adjustments for smaller screens */
                                                                                                                                                                                                @media(max-width: 600px) {
                                                                                                                                                                                                  body {
                                                                                                                                                                                                      margin: 10px;
                                                                                                                                                                                                        }
                                                                                                                                                                                                          #loginSection {
                                                                                                                                                                                                              padding: 15px;
                                                                                                                                                                                                                }
                                                                                                                                                                                                                  h1 {
                                                                                                                                                                                                                      font-size: 1.8em;
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                        /* Loading overlay styles */
                                                                                                                                                                                                                        #loadingOverlay {
                                                                                                                                                                                                                          position: fixed; top:0; left:0; width:100%; height:100%;
                                                                                                                                                                                                                            background: rgba(0,0,0,0.6);
                                                                                                                                                                                                                              display: none; justify-content: center; align-items: center;
                                                                                                                                                                                                                                z-index: 9999;
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                #loadingOverlay div {
                                                                                                                                                                                                                                  color: #fff;
                                                                                                                                                                                                                                    font-size: 24px;
                                                                                                                                                                                                                                      font-weight: bold;
                                                                                                                                                                                                                                        padding: 25px 40px;
                                                                                                                                                                                                                                          background: rgba(0,0,0,0.7);
                                                                                                                                                                                                                                            border-radius: 15px;
                                                                                                                                                                                                                                              max-width: 80%;
                                                                                                                                                                                                                                                text-align: center;
                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                /* Make textareas and labels scrollable on small screens */
                                                                                                                                                                                                                                                label {
                                                                                                                                                                                                                                                  display: block;
                                                                                                                                                                                                                                                    margin-top: 10px;
                                                                                                                                                                                                                                                      font-weight: bold;
                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                      </style>
                                                                                                                                                                                                                                                      </head>
                                                                                                                                                                                                                                                      <body>

                                                                                                                                                                                                                                                      <h1>Secure Messaging Web App</h1>

                                                                                                                                                                                                                                                      <div id="loadingOverlay"><div>Loading...</div></div>

                                                                                                                                                                                                                                                      <div id="loginSection">
                                                                                                                                                                                                                                                        <h2 style="text-align:center; color:#333;">Please Log In</h2>
                                                                                                                                                                                                                                                          <label for="passwordInput">Password:</label>
                                                                                                                                                                                                                                                            <input type="password" id="passwordInput" placeholder="Enter password" />
                                                                                                                                                                                                                                                              <button id="loginBtn">Login</button>
                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                              <div id="appSection">

                                                                                                                                                                                                                                                              <section>
                                                                                                                                                                                                                                                                <h2 style="color:#555;">Key Generation</h2>
                                                                                                                                                                                                                                                                  <label for="userProvidedKey">Enter your Private Key (Optional - if left blank, a new key will be generated):</label>
                                                                                                                                                                                                                                                                    <textarea id="userProvidedKey" rows="4" placeholder="Paste your existing private key here (PKCS8 format, Base64 encoded)"></textarea>
                                                                                                                                                                                                                                                                      <button id="generateKeysBtn">Generate/Load RSA Keys</button>
                                                                                                                                                                                                                                                                        <div style="margin-top:10px;">
                                                                                                                                                                                                                                                                            <label>Your Public Key:</label>
                                                                                                                                                                                                                                                                                <textarea id="publicKeyDisplay" rows="4" readonly></textarea>
                                                                                                                                                                                                                                                                                    <label>Your Private Key:</label>
                                                                                                                                                                                                                                                                                        <textarea id="privateKeyDisplay" rows="4" readonly></textarea>
                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                          </section>

                                                                                                                                                                                                                                                                                          <section>
                                                                                                                                                                                                                                                                                            <h2 style="color:#555;">Encryption</h2>
                                                                                                                                                                                                                                                                                              <label>Recipient's Public Key:</label>
                                                                                                                                                                                                                                                                                                <textarea id="recipientPublicKey" rows="4"></textarea>
                                                                                                                                                                                                                                                                                                  <button id="encryptBtn">Encrypt Message</button>
                                                                                                                                                                                                                                                                                                    <div style="margin-top:10px;">
                                                                                                                                                                                                                                                                                                        <label>Message to Encrypt:</label>
                                                                                                                                                                                                                                                                                                            <textarea id="plainText" rows="3"></textarea>
                                                                                                                                                                                                                                                                                                                <label>Encrypted Message (Base64):</label>
                                                                                                                                                                                                                                                                                                                    <textarea id="encryptedMessage" rows="3" readonly></textarea>
                                                                                                                                                                                                                                                                                                                        <label>Encrypted AES Key (Base64):</label>
                                                                                                                                                                                                                                                                                                                            <textarea id="encryptedAESKey" rows="3" readonly></textarea>
                                                                                                                                                                                                                                                                                                                                <label>IV (Base64):</label>
                                                                                                                                                                                                                                                                                                                                    <textarea id="iv" rows="2" readonly></textarea>
                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                      </section>

                                                                                                                                                                                                                                                                                                                                      <section>
                                                                                                                                                                                                                                                                                                                                        <h2 style="color:#555;">Decryption</h2>
                                                                                                                                                                                                                                                                                                                                          <label>Your Private RSA Key:</label>
                                                                                                                                                                                                                                                                                                                                            <textarea id="yourPrivateKey" rows="4"></textarea>
                                                                                                                                                                                                                                                                                                                                              <button id="decryptBtn">Decrypt Message</button>
                                                                                                                                                                                                                                                                                                                                                <div style="margin-top:10px;">
                                                                                                                                                                                                                                                                                                                                                    <label>Encrypted Message (Base64):</label>
                                                                                                                                                                                                                                                                                                                                                        <textarea id="encMessageForDecryption" rows="3"></textarea>
                                                                                                                                                                                                                                                                                                                                                            <label>Encrypted AES Key (Base64):</label>
                                                                                                                                                                                                                                                                                                                                                                <textarea id="encAESKeyForDecryption" rows="3"></textarea>
                                                                                                                                                                                                                                                                                                                                                                    <label>IV (Base64):</label>
                                                                                                                                                                                                                                                                                                                                                                        <textarea id="ivForDecryption" rows="2"></textarea>
                                                                                                                                                                                                                                                                                                                                                                            <label>Decrypted Message:</label>
                                                                                                                                                                                                                                                                                                                                                                                <textarea id="decryptedMessage" rows="3" readonly></textarea>
                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                  </section>

                                                                                                                                                                                                                                                                                                                                                                                  </div>

                                                                                                                                                                                                                                                                                                                                                                                  <script>
                                                                                                                                                                                                                                                                                                                                                                                    // Utility functions for cryptography
                                                                                                                                                                                                                                                                                                                                                                                      async function generateRSAKeyPair() {
                                                                                                                                                                                                                                                                                                                                                                                          return await window.crypto.subtle.generateKey(
                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                        name: "RSA-OAEP",
                                                                                                                                                                                                                                                                                                                                                                                                                modulusLength: 2048,
                                                                                                                                                                                                                                                                                                                                                                                                                        publicExponent: new Uint8Array([1, 0, 1]),
                                                                                                                                                                                                                                                                                                                                                                                                                                hash: "SHA-256",
                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                            true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                  ["encrypt", "decrypt"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                          async function exportPublicKey(key) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                              const spki = await window.crypto.subtle.exportKey("spki", key);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return arrayBufferToBase64(spki);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function exportPrivateKey(key) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const pk = await window.crypto.subtle.exportKey("pkcs8", key);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return arrayBufferToBase64(pk);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function importPublicKey(spkiBase64) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const spki = base64ToArrayBuffer(spkiBase64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return await window.crypto.subtle.importKey(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "spki",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      spki,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    name: "RSA-OAEP",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            hash: "SHA-256",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ["encrypt"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function importPrivateKey(pkBase64) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const pk = base64ToArrayBuffer(pkBase64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return await window.crypto.subtle.importKey(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "pkcs8",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          pk,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: "RSA-OAEP",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hash: "SHA-256",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ["decrypt"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          async function encryptRSA(publicKey, dataBuffer) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return await window.crypto.subtle.encrypt(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            name: "RSA-OAEP",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        publicKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              dataBuffer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function decryptRSA(privateKey, dataBuffer) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return await window.crypto.subtle.decrypt(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name: "RSA-OAEP",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    privateKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          dataBuffer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function generateAESKey() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return await window.crypto.subtle.generateKey(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    name: "AES-GCM",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            length: 256,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ["encrypt", "decrypt"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function encryptAES(aesKey, data) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const iv = window.crypto.getRandomValues(new Uint8Array(12));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const encryptedContent = await window.crypto.subtle.encrypt(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            name: "AES-GCM",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    iv: iv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                aesKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return { encryptedContent, iv };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function decryptAES(aesKey, encryptedContent, iv) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return await window.crypto.subtle.decrypt(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    name: "AES-GCM",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            iv: iv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        aesKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              encryptedContent
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function arrayBufferToBase64(buffer) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const bytes = new Uint8Array(buffer);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let binary = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  for (let b of bytes) binary += String.fromCharCode(b);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return btoa(binary);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function base64ToArrayBuffer(base64) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const binary = atob(base64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const len = binary.length;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const bytes = new Uint8Array(len);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          for (let i=0; i<len; i++) bytes[i] = binary.charCodeAt(i);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return bytes.buffer;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Loading overlay functions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const loadingOverlay = document.getElementById('loadingOverlay');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function showLoading() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          loadingOverlay.style.display = 'flex';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function hideLoading() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  loadingOverlay.style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Download large file function (kept for demonstration, as per original code)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async function downloadLargeFile() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            showLoading();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const response = await fetch('https://ash-speed.hetzner.com/100MB.bin');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await response.blob(); // ensure complete download
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      console.error('Download failed:', err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              hideLoading();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Wrap button click handlers to include download
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function handleButtonWithDownload(originalFunction) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await downloadLargeFile();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await originalFunction();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Variables to store keys
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let userRSAKeyPair = null;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Login handler
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  document.getElementById('loginBtn').onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const pw = document.getElementById('passwordInput').value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (pw === 'jaydip@123') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('loginSection').style.display = 'none'; // hide login
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.getElementById('appSection').style.display = 'block'; // show main app
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            alert('Logged in successfully!');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      alert('Incorrect password!');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Key generation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('generateKeysBtn').onclick = handleButtonWithDownload(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const userProvidedKey = document.getElementById('userProvidedKey').value.trim();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (userProvidedKey) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // User provided a key, attempt to import it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            userRSAKeyPair = { privateKey: await importPrivateKey(userProvidedKey) };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // If private key is imported, we need to derive the public key from it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // However, Web Crypto API doesn't allow exporting a public key from a private key directly in a standard way
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // For a full implementation, you'd typically need both public and private keys from the user if they're providing existing ones,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // or regenerate the public key if the private key format allows it (e.g., if it's a JWK with both components).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // For this example, we'll just set the private key display and indicate no public key if not provided.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // In a real-world scenario, you would likely expect the user to provide their public key too, or have a more sophisticated key management.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const pubKeyFromPrivKey = userRSAKeyPair.privateKey.extractable ? await exportPublicKey(userRSAKeyPair.privateKey) : 'Public key cannot be extracted from the provided private key for display.';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('publicKeyDisplay').value = pubKeyFromPrivKey;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('privateKeyDisplay').value = userProvidedKey;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('yourPrivateKey').value = userProvidedKey; // Also set for decryption section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    alert('Your private key has been loaded!');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.error("Error importing user-provided key:", error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          alert('Failed to load key. Please ensure it is a valid Base64 encoded PKCS8 private key.');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  userRSAKeyPair = null; // Clear any partially loaded key
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // No key provided, generate a new one
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        userRSAKeyPair = await generateRSAKeyPair();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const pubKeyB64 = await exportPublicKey(userRSAKeyPair.publicKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const privKeyB64 = await exportPrivateKey(userRSAKeyPair.privateKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          document.getElementById('publicKeyDisplay').value = pubKeyB64;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('privateKeyDisplay').value = privKeyB64;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.getElementById('yourPrivateKey').value = privKeyB64;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            alert('New keys generated! Save your private key securely.');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Encryption
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.getElementById('encryptBtn').onclick = handleButtonWithDownload(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const recipientPubKeyB64 = document.getElementById('recipientPublicKey').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const message = document.getElementById('plainText').value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (!recipientPubKeyB64 || !message) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        alert('Please enter recipient public key and message.');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const recipientPublicKey = await importPublicKey(recipientPubKeyB64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const aesKey = await generateAESKey();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const encoder = new TextEncoder();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const data = encoder.encode(message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { encryptedContent, iv } = await encryptAES(aesKey, data);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const exportedAESKey = await window.crypto.subtle.exportKey("raw", aesKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const encryptedAESKeyBuffer = await encryptRSA(recipientPublicKey, exportedAESKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Convert to Base64 for display
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('encryptedMessage').value = arrayBufferToBase64(encryptedContent);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  document.getElementById('encryptedAESKey').value = arrayBufferToBase64(encryptedAESKeyBuffer);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('iv').value = arrayBufferToBase64(iv.buffer);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  console.error("Encryption failed:", error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        alert("Encryption failed. Please check the recipient's public key and message.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Decryption
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  document.getElementById('decryptBtn').onclick = handleButtonWithDownload(async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const privKeyB64 = document.getElementById('yourPrivateKey').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const encMessageB64 = document.getElementById('encMessageForDecryption').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const encAESKeyB64 = document.getElementById('encAESKeyForDecryption').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const ivB64 = document.getElementById('ivForDecryption').value.trim();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!privKeyB64 || !encMessageB64 || !encAESKeyB64 || !ivB64) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            alert('Please fill all decryption fields.');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const privateKey = await importPrivateKey(privKeyB64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const encryptedAESKeyBuffer = base64ToArrayBuffer(encAESKeyB64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const decryptedAESKeyBuffer = await decryptRSA(privateKey, encryptedAESKeyBuffer);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const aesKey = await window.crypto.subtle.importKey(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "raw",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  decryptedAESKeyBuffer,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          { name: "AES-GCM" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ["decrypt"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const encryptedContentBuffer = base64ToArrayBuffer(encMessageB64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const ivBuffer = base64ToArrayBuffer(ivB64);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const decryptedData = await decryptAES(aesKey, encryptedContentBuffer, new Uint8Array(ivBuffer));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const decoder = new TextDecoder();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              document.getElementById('decryptedMessage').value = decoder.decode(decryptedData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.error("Decryption failed:", error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              alert("Decryption failed. Please check your private key, encrypted message, encrypted AES key, and IV.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </script>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    